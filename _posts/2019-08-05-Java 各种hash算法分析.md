---
title: 2019-8-5-Java å„ç§hashç®—æ³•åˆ†æ
tags: Java
---
>Hash, æŠŠä»»æ„é•¿åº¦çš„è¾“å…¥, é€šè¿‡æ•£åˆ—ç®—æ³•, è½¬åŒ–ä¸ºä¸€ä¸ªå®šé•¿çš„å€¼.
>æ•£åˆ—ç®—æ³•çš„ä¸€ä¸ªç‰¹æ€§:*æ ¹æ®åŒä¸€æ•£åˆ—ç®—æ³•ç®—å‡ºæ¥çš„å€¼, å¦‚æœè¾“å…¥å€¼æ˜¯ä¸åŒçš„, é‚£ä¹ˆè¾“å‡ºå€¼ä¹Ÿä¸åŒ, ä½†æ˜¯æ ¹æ®åŒä¸€å‡½æ•°ç®—å‡ºæ¥çš„æ•£åˆ—å€¼ç›¸åŒ, é‚£ä¹ˆè¾“å…¥å€¼ä¸ä¸€å®šç›¸åŒ.(å“ˆå¸Œå†²çª)*


æ ¹æ®æ•£åˆ—ç®—æ³•çš„ç‰¹æ€§, javadocä¸­è¯´æ˜äº†java `hashcode`çš„å‡†åˆ™:
æ¦‚æ‹¬æ¥è¯´å°±æ˜¯å¦‚æœequals()æ–¹æ³•è¿”å›true, é‚£ä¹ˆç”Ÿæˆçš„hashcodeä¸€å®šç›¸åŒ, å¦‚æœequals()æ–¹æ³•è¿”å›false, é‚£ä¹ˆç”Ÿæˆçš„hashcodeåˆ™å¯èƒ½ç›¸åŒä¹Ÿå¯èƒ½ä¸åŒ.(*è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆjavadocä¸Šè¦æ±‚, equals()æ–¹æ³•å’Œhashcode()æ–¹æ³•å°½é‡ä¸€èµ·é‡å†™çš„åŸå› *)

çœ‹èµ·æ¥æœ‰ç‚¹ç»•å£, å†ç®€ç•¥ä¸€ä¸‹, **hashcodeç›¸ç­‰æ˜¯ä¸¤ä¸ªå®ä¾‹ç›¸ç­‰çš„å‰ææ¡ä»¶.**

åœ¨Object(æ‰€æœ‰ç±»å‹çš„æ ¹ç±»)é‡Œå°±æœ‰äº†ä¸€ä¸ª`JNI`çš„`public native int hashCode()`çš„æ–¹æ³•, è¿™æ ·çš„hashç®—æ³•åœ¨å¤šæ•°æƒ…å†µä¸‹ç»™äº†å®ä¾‹ä¹‹é—´ç›¸äº’è¿›è¡Œæ¯”è¾ƒçš„ä¸€ä¸ªå‰æå˜é‡,  ä¼˜åŒ–äº†è¿›è¡Œæ¯”è¾ƒæ—¶å€™æ‰€äº§ç”Ÿçš„æ€§èƒ½å¼€é”€. è¯¥JNIæ–¹æ³•é€šè¿‡å°†å®ä¾‹çš„å†…å­˜åœ°å€è½¬åŒ–ä¸ºint.ä½†æ˜¯ä¸ç­‰äºç›´æ¥çš„å†…å­˜åœ°å€.

ä»¥ä¸‹æºç , å¦‚æ²¡æœ‰æ˜ç¡®æŒ‡æ˜, å°±æ˜¯openjdk8ä¸­çš„æºç .

### Stringçš„hashcode()
Stringæ˜¯æˆ‘ä»¬æ—¥å¸¸å‡ ä¹ç¦»ä¸å¼€çš„ä¸€ä¸ªç±», è€Œä¸”æ˜¯Immutableçš„, æ‰€ä»¥å…ˆæ¥çœ‹çœ‹Stringçš„é‡å†™

```java

    /** Cache the hash code for the string */
    private int hash; // Default to 0
    public int hashCode() {
        int h = hash;
        if (h == 0 && value.length > 0) {
            char val[] = value;

            for (int i = 0; i < value.length; i++) {
                h = 31 * h + val[i];
            }
            hash = h;
        }
        return h;
    }

```

é¦–å…ˆStringæ˜¯Immutable(ä¸å¯å˜)çš„, æ‰€ä»¥åˆå§‹åŒ–ä¹‹å, hashcodeä¹Ÿå°±éšä¹‹ç¡®å®šäº†, ç±»ä¸­æœ‰ä¸€ä¸ªå­—æ®µ`hash`æ¥ä¿å­˜ç€ä¸ä¼šå˜åŒ–çš„å“ˆå¸Œå€¼, åæ­£ä¸ä¼šå˜, è‚¯å®šè®¡ç®—ä¸€æ¬¡å°±å¤Ÿäº†, ä¿å­˜ä¸‹æ¥, ä»¥åè°ƒç”¨çš„æ—¶å€™ç›´æ¥è¿”å›å°±è¡Œäº†. æ‰€ä»¥`if(h == 0 &&h == 0 && value.length > 0)`é¿å…äº†å“ˆå¸Œå€¼çš„äºŒæ¬¡è®¡ç®—å’Œç©ºå­—ç¬¦ä¸²çš„è®¡ç®—.


å¯ä»¥çœ‹å‡ºhash=s[0]*31^(n-1) + s[1]*31^(n-2) + ... + s[n-1]  , ä½†æ˜¯ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢? javadocä¸­å¹¶æ²¡æœ‰ç»™å‡º, ä½†æ˜¯è¿™å°±æ˜¯ç ”ç©¶æºç çš„ç›®çš„æ‰€åœ¨, æ‰€ä»¥å°±å»æŸ¥.


åœ¨stackoverflowä¸Šæœ€é«˜ç¥¨çš„è§£ç­”æ˜¯[Why does Java's hashCode() in String use 31 as a multiplier?](https://stackoverflow.com/questions/299304/why-does-javas-hashcode-in-string-use-31-as-a-multiplier) 

è¿™ä¸ªäººä¹Ÿæ˜¯å¼•ç”¨äº†<\<Effective Java>>ä¸­çš„è§‚ç‚¹. ä¸‹é¢è§£é‡Šä¸‹:

>é€‰æ‹©å€¼31æ˜¯å› ä¸ºå®ƒæ˜¯å¥‡æ•°å’Œç´ æ•°ã€‚å¦‚æœå®ƒæ˜¯å¶æ•°å¹¶ä¸”ä¹˜æ³•æº¢å‡ºï¼Œåˆ™ä¿¡æ¯å°†ä¸¢å¤±ï¼Œå› ä¸ºä¹˜ä»¥2ç›¸å½“äºç§»ä½ã€‚ä½¿ç”¨ç´ æ•°çš„ä¼˜åŠ¿ä¸å¤ªæ˜æ˜¾ï¼Œä½†è¿™æ˜¯ä¼ ç»Ÿçš„æ€è·¯ã€‚ 31çš„ä¸€ä¸ªå¾ˆå¥½çš„å±æ€§æ˜¯ä¹˜æ³•å¯ä»¥ç”¨ç§»ä½å’Œå‡æ³•ä»£æ›¿ä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼š31 * i ==ï¼ˆi << 5ï¼‰ - iã€‚JVMä¼šå¯¹è¿™ä¸ªä¹˜æ³•è‡ªåŠ¨è¿›è¡Œä¼˜åŒ–.


>å¤§å¤šæ•°hashç®—æ³•éƒ½ä¼šé€‰æ‹©ä¸ç´ æ•°è¿›è¡Œè¿ç®—, è¿™æ ·èƒ½é¿å…hashå†²çª, 31ä¸€ä¸ªä¸å¤§ä¸å°çš„ç´ æ•°, æ˜¯ä¸ªå¾ˆå¥½çš„é€‰æ‹©. æœ€é‡è¦çš„JVMä¼šå¯¹æ­¤è¿›è¡Œä¼˜åŒ–! 


### HashMapçš„hashç®—æ³•
HashMapæ˜¯åŸºäº`æ•°ç»„+é“¾è¡¨\çº¢é»‘æ ‘`çš„ä¸€ç§å¸¸ç”¨çš„Mapç»“æ„. HashMapçš„æ•°ç»„åˆå§‹é•¿åº¦æ˜¯16, ä¹‹åæ¯æ¬¡æ‰©å±•ä¸ºåŸæ¥çš„ä¸¤å€. è¿™æ˜¯è¦è¯´HashMapçš„hashç®—æ³•çš„å‰æçŸ¥è¯†, å¦‚æœä½ å¯¹æ­¤ä¸å¤ªäº†è§£, å»ºè®®å…ˆå»äº†è§£ä¸€ä¸‹.

HashMapä¸ºäº†é¿å…hashå†²çª, æ²¡æœ‰ç›´æ¥é‡‡ç”¨Keyçš„hashå€¼çš„é»˜è®¤è¿”å›, è€Œå¯¹å…¶è¿›è¡Œäº†äºŒæ¬¡æ•£åˆ—è¿ç®—, çœ‹ä¸‹æºç :

```java
    static final int hash(Object key) {
        int h;
        return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
    }
	// >>ä¸ºæœ‰ç¬¦å·å³ç§», >>>ä¸ºæ— ç¬¦å·å³ç§». æœ‰ç¬¦å·ä¼šä¿æŒåŸæ•°çš„æ­£è´Ÿæ€§, è€Œæ— ç¬¦å·åˆ™ä¸ä¼š, é»˜è®¤è¡¥0
```
HashMapæ”¯æŒå”¯ä¸€çš„keyä¸ºnull, å¹¶ä¸”ä»æºç ä¸­å¯ä»¥çœ‹å‡ºæ¥, é»˜è®¤çš„é”®å€¼ä¸ºnullçš„æ•°ç»„ä¸‹æ ‡ä¸º0.
å¦‚æœkeyénull, åˆ™æ‹¿keyçš„hashcodeä¸å…¶æœ¬èº«keyçš„hashcodeçš„é«˜16ä½çš„å€¼åšå¹‚è¿ç®—.

ä¸ºä»€ä¹ˆå¥½å¥½çš„keyçš„é»˜è®¤è¿”å›å€¼ä¸ç”¨, éè¦äºŒæ¬¡è¿ç®—å‘¢?(æ‰°ä¹±è¿ç®—)
å…ˆåˆ«ç€æ€¥, è¿™è¦æ ¹æ®hashmapå¯»æ‰¾æ•°ç»„indexçš„ç»“åˆèµ·æ¥ä¸€èµ·è¯´è¾ƒå®¹æ˜“ç†è§£.

å¦‚æœæ˜¯"å±Œä¸"å†™æ³•, é‚£ä¹ˆè‚¯å®šæ˜¯hash%length, è¿™æ ·å°±èƒ½å¾—åˆ°tableæ•°ç»„ä¸‹æ ‡, ä½†æ˜¯å†™jdkèƒ½æ˜¯å±Œä¸ä¹ˆ??? (æ»‘ç¨½)
å…ˆçœ‹ä¸‹jdk7ä¸­çš„å¯»æ‰¾æ•°ç»„ä¸‹æ ‡çš„å®ç°, é€šè¿‡ä¸æ•°ç»„é•¿åº¦æ±‚ä¸è¿ç®—å¾—åˆ°å…·ä½“çš„æ•°ç»„ä¸‹æ ‡, è¿™é‡Œçš„åŸç†æ˜¯é’ˆå¯¹x & 2^n-1 (hashmapçš„æ•°ç»„å¤§å°å°±æ˜¯2^n) çš„ä¸è¿ç®—, æ˜¯å’Œx % nçš„è¿ç®—ç»“æœæ˜¯ä¸€æ ·çš„, ä½†æ˜¯&è¿ç®—è‚¯å®šæ¯”%æ•ˆç‡è¦é«˜çš„å¤š, ä¸¾ä¸ªä¾‹å­:  
6 % 8 = 6                ==              6 & 7 = 6  
6 : 000110<br>
7 : 000111<br>
6 : 000110<br>
é’ˆå¯¹äºå…¶ä»–çš„2^n-1, ç»“æœä¹Ÿéƒ½æ˜¯ä¸€æ ·çš„.
æ‰€ä»¥, å¤§ä½¬å°±æ˜¯å¤§ä½¬, æ¯”ä¸äº†å•Š,

```java
//jdk7
static int indexFor(int h, int length) {
    return h & (length-1);
}

//jdk8
    final Node<K,V> getNode(int hash, Object key) {
        Node<K,V>[] tab; Node<K,V> first, e; int n; K k;
        if ((tab = table) != null && (n = tab.length) > 0 &&
            (first = tab[(n - 1) & hash]) != null) {
            if (first.hash == hash && // always check first node
                ((k = first.key) == key || (key != null && key.equals(k))))
                return first;
            if ((e = first.next) != null) {
                if (first instanceof TreeNode)
                    return ((TreeNode<K,V>)first).getTreeNode(hash, key);
                do {
                    if (e.hash == hash &&
                        ((k = e.key) == key || (key != null && key.equals(k))))
                        return e;
                } while ((e = e.next) != null);
            }
        }
        return null;
    }
```

jdk8ä¸­çš„æ²¡æœ‰äº†indexFor()å‡½æ•°, è€Œæ˜¯ç›´æ¥åœ¨å¯»æ‰¾nodeèŠ‚ç‚¹ä¸­çš„å‡½æ•°å®ç°, å…·ä½“çš„å°±æ˜¯:
```java
        Node<K,V>[] tab; Node<K,V> first, e; int n; K k;
        if ((tab = table) != null && (n = tab.length) > 0 &&
            (first = tab[(n - 1) & hash]) != null) {
```
å°±æ˜¯ä¸Šé¢ä¸­çš„`[(n-1)&hash] `, hashæ˜¯keyçš„æœ€ç»ˆhashå€¼.
è¿™é‡Œå‡è®¾n-1 = 15, hash = 6, æˆ‘ä»¬æ¥çœ‹ä¸‹ 6 % 16 = 6  == 6 & (16 -1)
00000000000000000000000000001111<br>
00000000000000000000000000000110<br>
00000000000000000000000000000110<br>
è¿™é‡Œè¦æ³¨æ„, 0ä¸ä»»ä½•æ•°æ±‚ä¸éƒ½æ˜¯0, ä¹Ÿå°±æ˜¯æ— è®ºhashæ˜¯å¤šå°‘, æ•°ç»„çš„é•¿åº¦çš„äºŒè¿›åˆ¶ä½æ•°ä»£è¡¨äº†æœ€ç»ˆå‚ä¸ `ä¸è¿ç®—`çš„ä½æ•°.
å¥½äº†åˆ†æäº†æ•°ç»„çš„ä¸‹æ ‡å¯»å€è¿‡ç¨‹, è¿™æ ·æˆ‘ä»¬å°±èƒ½è¯´ä¸‹ä¸ºä»€ä¹ˆkeyçš„hashå€¼è¦äºŒæ¬¡è®¡ç®—.
é¦–å…ˆçœ‹ä¸‹  
10101010101101010011100101000101<br>
00000000000000000000000000000101
æ¯”è¾ƒä¸€ä¸‹è¿™ä¸¤ä¸ªhash, å¦‚æœæ•°ç»„çš„é•¿åº¦æ˜¯16, é‚£ä¹ˆåªæœ‰hashçš„å4ä½å‚ä¸`ä¸è¿ç®—`, ä½†æ˜¯ç€ä¸¤ä¸ªæ˜¯ç›¸å·®å¾ˆå¤§æ•°å•Š,  **æ‰€ä»¥ä¸ºäº†é¿å…æ•°ç»„å¯»å€ä¸è¿ç®—é€ æˆçš„é¢‘ç¹"ä½ä½"å“ˆå¸Œå†²çª, æ‰€ä»¥keyçš„hashå€¼è¿›è¡Œäº†äºŒæ¬¡è¿ç®—**,  è¿™é‡Œçš„äºŒæ¬¡å“ˆå¸Œè®¡ç®—æ˜¯ä¸€ç§æ‰°ä¹±å‡½æ•°, ` (h = key.hashCode()) ^ (h >>> 16)`**ä½œç”¨æ˜¯è®©é«˜ä½ä¹Ÿå‚ä¸åˆ°æ•°ç»„çš„ç¡®å®šä¸‹æ ‡è¿ç®—ä¸­, ä»è€Œé¿å…äº†ç¡®å®šåœ°å€çš„è¿ç®—åªä¾èµ–äºä½ä½**. (è¿™é‡Œçš„ä½ä½å’Œé«˜ä½æ˜¯keyçš„é»˜è®¤hashå€¼çš„äºŒè¿›åˆ¶çš„è¡¨è¾¾å½¢å¼)

çœŸğŸ®,  è¿™ç§å¯¹ä»£ç ç²¾ç›Šæ±‚ç²¾çš„æ€åº¦. è¿™ä¹Ÿä¿è¯äº†æˆ‘ä»¬å¹³æ—¶ç”¨çš„æ•°æ®ç»“æ„çš„ç®—æ³•æ˜¯æœ€ä¼˜çš„, æ„Ÿè°¢è¿™ç¾¤äºº. 